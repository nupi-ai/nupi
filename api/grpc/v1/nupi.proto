syntax = "proto3";

package nupi.api.v1;

option go_package = "github.com/nupi-ai/nupi/internal/api/grpc/v1;v1";

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/wrappers.proto";

// DaemonStatusRequest asks for a snapshot of the daemon's current state.
message DaemonStatusRequest {}

// DaemonStatusResponse returns the daemon's runtime status including version,
// session count, network bindings, and security configuration.
message DaemonStatusResponse {
  string version = 1;
  int32 sessions_count = 2;
  int32 port = 3;
  int32 grpc_port = 4;
  string binding = 5;
  string grpc_binding = 6;
  bool auth_required = 7;
  double uptime_sec = 8;
  bool tls_enabled = 9;
  int32 connect_port = 10;
}

// Session represents a managed PTY session with its process state and metadata.
message Session {
  string id = 1;
  string command = 2;
  repeated string args = 3;
  string status = 4;
  int32 pid = 5;
  google.protobuf.Timestamp start_time = 6;
  google.protobuf.Int32Value exit_code = 7;  // Absent (null) while running; present once process exits
  string work_dir = 8;
  string tool = 9;             // Detected AI tool (e.g. "claude", "chatgpt")
  string tool_icon = 10;       // Tool icon identifier
  string tool_icon_data = 11;  // Base64-encoded icon data
  string mode = 12;            // Session mode (e.g. "inspect")
}

// ListSessionsRequest asks for all active sessions managed by the daemon.
message ListSessionsRequest {}

// ListSessionsResponse returns the list of sessions.
message ListSessionsResponse {
  repeated Session sessions = 1;
}

// CreateSessionRequest starts a new PTY session running the specified command.
message CreateSessionRequest {
  string command = 1;
  repeated string args = 2;
  string working_dir = 3;
  repeated string env = 4;
  uint32 rows = 5;
  uint32 cols = 6;
  bool detached = 7;
  bool inspect = 8;
}

// CreateSessionResponse returns the newly created session.
message CreateSessionResponse {
  Session session = 1;
}

// KillSessionRequest terminates a session by ID.
message KillSessionRequest {
  string session_id = 1;
}

// KillSessionResponse is empty on success.
message KillSessionResponse {}

// ConversationMetadata stores auxiliary information about a conversation turn,
// mirroring key/value annotations produced by the conversation service.
message ConversationMetadata {
  // Metadata key (for example "tool_id" or "prompt_id").
  string key = 1;
  // Metadata value stored as plain text.
  string value = 2;
}

// ConversationTurn represents a single entry in the conversational history.
message ConversationTurn {
  // Origin identifies the logical author (user/ai/tool/system).
  string origin = 1;
  // Normalised textual content produced by the pipeline.
  string text = 2;
  // Timestamp in UTC when the turn was recorded.
  google.protobuf.Timestamp at = 3;
  // Optional metadata annotations attached to the turn.
  repeated ConversationMetadata metadata = 4;
}

// GetConversationRequest asks for the conversation history of a session.
message GetConversationRequest {
  // Target session identifier.
  string session_id = 1;
  // Optional zero-based offset for pagination.
  uint32 offset = 2;
  // Optional limit for the number of turns returned.
  uint32 limit = 3;
}

// GetConversationResponse returns the ordered list of turns for the session.
message GetConversationResponse {
  string session_id = 1;
  repeated ConversationTurn turns = 2;
  uint32 offset = 3;
  uint32 limit = 4;
  uint32 total = 5;
  bool has_more = 6;
  uint32 next_offset = 7;
}

// GetGlobalConversationRequest asks for the global (sessionless) conversation history.
message GetGlobalConversationRequest {
  uint32 offset = 1;
  uint32 limit = 2;
}

// GetGlobalConversationResponse returns the ordered list of global turns.
message GetGlobalConversationResponse {
  repeated ConversationTurn turns = 1;
  uint32 offset = 2;
  uint32 limit = 3;
  uint32 total = 4;
  bool has_more = 5;
  uint32 next_offset = 6;
}

// AdapterRuntime exposes runtime metadata for an adapter process.
message AdapterRuntime {
  string adapter_id = 1;
  string health = 2;
  string message = 3;
  google.protobuf.Timestamp started_at = 4;
  google.protobuf.Timestamp updated_at = 5;
  map<string, string> extra = 6;
}

// AdapterEntry mirrors adapter binding status together with runtime info.
message AdapterEntry {
  string slot = 1;
  optional string adapter_id = 2;
  string status = 3;
  string config_json = 4;
  google.protobuf.Timestamp updated_at = 5;
  AdapterRuntime runtime = 6;
}

// AdaptersOverviewResponse summarizes adapter slots.
message AdaptersOverviewResponse {
  repeated AdapterEntry adapters = 1;
}

// BindAdapterRequest activates an adapter for a slot.
message BindAdapterRequest {
  string slot = 1;
  string adapter_id = 2;
  string config_json = 3;
}

// AdapterSlotRequest targets a single slot for start/stop actions.
message AdapterSlotRequest {
  string slot = 1;
}

// AdapterActionResponse returns the updated binding entry.
message AdapterActionResponse {
  AdapterEntry adapter = 1;
}

// AudioFormat describes the encoding parameters of an audio stream.
message AudioFormat {
  string encoding = 1;       // e.g. pcm_s16le
  uint32 sample_rate = 2;    // Hz
  uint32 channels = 3;       // mono=1, stereo=2
  uint32 bit_depth = 4;      // bits per sample
  uint32 frame_duration_ms = 5;
}

// AudioChunk carries a segment of audio data with sequencing metadata.
message AudioChunk {
  bytes data = 1;
  uint64 sequence = 2;
  uint32 duration_ms = 3;
  bool first = 4;
  bool last = 5;
  map<string, string> metadata = 6;
}

// StreamAudioInRequest sends captured audio frames from the client to the daemon.
message StreamAudioInRequest {
  string session_id = 1;
  string stream_id = 2;
  AudioFormat format = 3; // optional after first chunk
  AudioChunk chunk = 4;
}

// StreamAudioInResponse acknowledges the received audio and reports readiness.
message StreamAudioInResponse {
  uint64 ack_sequence = 1;
  bool ready = 2;
  string message = 3;
}

// StreamAudioOutRequest subscribes to TTS audio playback for a session.
message StreamAudioOutRequest {
  string session_id = 1;
  string stream_id = 2;
}

// StreamAudioOutResponse delivers a TTS audio chunk from the daemon.
message StreamAudioOutResponse {
  AudioFormat format = 1;
  AudioChunk chunk = 2;
}

// InterruptTTSRequest asks the daemon to stop TTS playback (barge-in).
message InterruptTTSRequest {
  string session_id = 1;
  string stream_id = 2;
  string reason = 3;
}

// GetAudioCapabilitiesRequest queries the daemon's audio I/O capabilities.
message GetAudioCapabilitiesRequest {
  string session_id = 1;
}

// AudioCapability describes a single audio capture or playback capability.
message AudioCapability {
  string stream_id = 1;
  AudioFormat format = 2;
  map<string, string> metadata = 3;
}

// GetAudioCapabilitiesResponse lists available capture and playback streams.
message GetAudioCapabilitiesResponse {
  repeated AudioCapability capture = 1;
  repeated AudioCapability playback = 2;
}

// ─── Session streaming (AD-7: AttachSession bidirectional) ───

// SessionEventType identifies the kind of session lifecycle event.
enum SessionEventType {
  SESSION_EVENT_TYPE_UNSPECIFIED = 0;
  SESSION_EVENT_TYPE_CREATED = 1;
  SESSION_EVENT_TYPE_KILLED = 2;
  SESSION_EVENT_TYPE_STATUS_CHANGED = 3;
  SESSION_EVENT_TYPE_MODE_CHANGED = 4;
  SESSION_EVENT_TYPE_TOOL_DETECTED = 5;
  SESSION_EVENT_TYPE_RESIZE_INSTRUCTION = 6;
}

// AttachInit is the first message a client sends to join a session stream.
message AttachInit {
  string session_id = 1;
  bool include_history = 2;
}

// ResizeRequest asks the daemon to resize a session PTY.
message ResizeRequest {
  uint32 cols = 1;
  uint32 rows = 2;
  string source = 3;
  map<string, string> metadata = 4;
}

// SessionEvent carries a session lifecycle notification.
message SessionEvent {
  SessionEventType type = 1;
  string session_id = 2;
  map<string, string> data = 3;
}

// AttachSessionRequest multiplexes client-to-daemon messages on a session stream.
message AttachSessionRequest {
  oneof payload {
    AttachInit init = 1;
    bytes input = 2;
    ResizeRequest resize = 3;
    string control = 4; // "detach" or "kill"
  }
}

// AttachSessionResponse multiplexes daemon-to-client messages on a session stream.
message AttachSessionResponse {
  oneof payload {
    bytes output = 1;
    SessionEvent event = 2;
  }
}

// ─── Additional session management ───

// GetSessionRequest retrieves a single session by ID.
message GetSessionRequest {
  string session_id = 1;
}

// GetSessionResponse returns the requested session.
message GetSessionResponse {
  Session session = 1;
}

// SendInputRequest writes data to a session's stdin (non-streaming alternative to AttachSession).
message SendInputRequest {
  string session_id = 1;
  bytes input = 2;
  bool eof = 3;
}

// SendInputResponse is empty on success.
message SendInputResponse {}

// SendVoiceCommandRequest sends transcribed speech text to a session's AI pipeline.
message SendVoiceCommandRequest {
  string session_id = 1;              // Optional — empty string for global/sessionless
  string text = 2;                    // Required — transcribed speech (server trims leading/trailing whitespace)
  map<string, string> metadata = 3;   // Optional — source, confidence, etc.
}

// SendVoiceCommandResponse acknowledges the voice command was accepted.
message SendVoiceCommandResponse {
  bool accepted = 1;
  string message = 2;
}

// ─── Session mode management ───

// GetSessionModeRequest asks for the current mode of a session.
message GetSessionModeRequest {
  string session_id = 1;
}

// GetSessionModeResponse returns the current session mode.
message GetSessionModeResponse {
  string session_id = 1;
  string mode = 2;
}

// SetSessionModeRequest changes the mode of a session (e.g. "inspect").
message SetSessionModeRequest {
  string session_id = 1;
  string mode = 2;
}

// SetSessionModeResponse returns the updated session mode.
message SetSessionModeResponse {
  string session_id = 1;
  string mode = 2;
}

// ─── Daemon control ───

// ShutdownRequest asks the daemon to terminate gracefully.
message ShutdownRequest {}

// ShutdownResponse confirms the shutdown and may include a message.
message ShutdownResponse {
  string message = 1;
}

// GetPluginWarningsRequest asks for plugin discovery warnings.
message GetPluginWarningsRequest {}

// PluginWarning mirrors PluginDiscoveryWarning from the plugin loader.
message PluginWarning {
  string dir = 1;
  string error = 2;
}

// GetPluginWarningsResponse returns warnings from the last plugin scan.
message GetPluginWarningsResponse {
  repeated PluginWarning warnings = 1;
}

// ReloadPluginsRequest triggers a hot-reload of all plugin indices.
message ReloadPluginsRequest {}

// ReloadPluginsResponse confirms the reload.
message ReloadPluginsResponse {
  string message = 1;
}

// ─── Authentication ───

// TokenInfo describes an authentication token with its value masked.
message TokenInfo {
  string id = 1;
  string name = 2;
  string role = 3;
  string masked_value = 4;
  google.protobuf.Timestamp created_at = 5;
}

// ListTokensRequest asks for all authentication tokens.
message ListTokensRequest {}

// ListTokensResponse returns tokens with masked values.
message ListTokensResponse {
  repeated TokenInfo tokens = 1;
}

// CreateTokenRequest generates a new authentication token.
message CreateTokenRequest {
  string name = 1;
  string role = 2;
}

// CreateTokenResponse returns the full token value (shown once) and its metadata.
message CreateTokenResponse {
  string token = 1;
  TokenInfo info = 2;
}

// DeleteTokenRequest identifies a token to revoke. Provide either the record
// ID (from ListTokens) or the full token value — the daemon tries ID first,
// then falls back to value lookup.
message DeleteTokenRequest {
  // Token record identifier returned by ListTokens.
  string id = 1;
  // Full token string (used when the record ID is unknown).
  string token = 2;
}

// PairingInfo describes a device pairing code and its claim status.
message PairingInfo {
  string code = 1;
  string name = 2;
  string role = 3;
  google.protobuf.Timestamp expires_at = 4;
  bool claimed = 5;
  google.protobuf.Timestamp created_at = 6;
}

// ListPairingsRequest asks for all active pairing codes.
message ListPairingsRequest {}

// ListPairingsResponse returns the list of pairing codes.
message ListPairingsResponse {
  repeated PairingInfo pairings = 1;
}

// CreatePairingRequest generates a new time-limited pairing code for device enrollment.
message CreatePairingRequest {
  string name = 1;
  string role = 2;
  int32 expires_in_seconds = 3;
}

// CreatePairingResponse returns the pairing code and its expiry.
message CreatePairingResponse {
  string code = 1;
  google.protobuf.Timestamp expires_at = 2;
  string name = 3;
  string role = 4;
  string connect_url = 5;
}

// ClaimPairingRequest exchanges a pairing code for an auth token (no auth required).
message ClaimPairingRequest {
  string code = 1;
  string client_name = 2;
}

// ClaimPairingResponse returns the auth token and daemon connection details.
message ClaimPairingResponse {
  string token = 1;
  string daemon_host = 2;
  int32 daemon_port = 3;
  bool tls = 4;
  string name = 5;
  string role = 6;
  google.protobuf.Timestamp created_at = 7;
}

// ─── Adapter management extensions ───

// AdapterEndpointConfig describes how the daemon connects to an adapter process.
message AdapterEndpointConfig {
  string transport = 1;        // "grpc", "http", or "process"
  string address = 2;          // Network address or socket path (grpc/http)
  string command = 3;          // Executable path (process transport)
  repeated string args = 4;    // Command arguments (process transport)
  map<string, string> env = 5; // Environment variables (process transport)
}

message RegisterAdapterRequest {
  string adapter_id = 1;
  string manifest_yaml = 2;
  string source = 3;           // e.g. "marketplace", "local", "builtin"
  string version = 4;
  string type = 5;             // stt, tts, ai, vad, tunnel, tool-handler, pipeline-cleaner
  string name = 6;
  AdapterEndpointConfig endpoint = 7;
}

message RegisterAdapterResponse {
  string adapter_id = 1;
  string name = 2;
  string type = 3;
  string version = 4;
  string source = 5;
  string manifest_yaml = 6;
}

message StreamAdapterLogsRequest {
  string slot = 1;
  bool follow = 2;
  string adapter = 3;          // Optional adapter ID filter
}

// AdapterLogEntry represents a log line from an adapter process.
message AdapterLogEntry {
  google.protobuf.Timestamp timestamp = 1;
  string level = 2;
  string message = 3;
  string slot = 4;
  string adapter_id = 5;
}

// TranscriptEntry represents a speech-to-text transcript event.
message TranscriptEntry {
  google.protobuf.Timestamp timestamp = 1;
  string session_id = 2;
  string stream_id = 3;
  string text = 4;
  double confidence = 5;       // 0.0–1.0
  bool is_final = 6;            // true for final transcript, false for partial
}

// AdapterLogStreamEntry multiplexes log and transcript events on a single stream.
message AdapterLogStreamEntry {
  oneof payload {
    AdapterLogEntry log = 1;
    TranscriptEntry transcript = 2;
  }
}

message GetAdapterLogsRequest {
  string slot = 1;
  uint32 limit = 2;
  string adapter = 3;          // Optional adapter ID filter
}

message GetAdapterLogsResponse {
  repeated AdapterLogStreamEntry entries = 1;
}

// ─── Recordings ───

// Recording describes a terminal session recording (asciicast format).
message Recording {
  string session_id = 1;
  string filename = 2;
  string command = 3;
  repeated string args = 4;
  string work_dir = 5;
  google.protobuf.Timestamp start_time = 6;
  double duration_sec = 7;     // Duration in seconds
  uint32 rows = 8;
  uint32 cols = 9;
  string title = 10;
  string tool = 11;            // Detected AI tool
  string recording_path = 12;  // Absolute path to .cast file
}

// ListRecordingsRequest asks for recording metadata, optionally filtered by session.
message ListRecordingsRequest {
  string session_id = 1; // optional filter
}

// ListRecordingsResponse returns the list of recordings.
message ListRecordingsResponse {
  repeated Recording recordings = 1;
}

// GetRecordingRequest starts streaming the raw recording file for a session.
message GetRecordingRequest {
  string session_id = 1;
}

// RecordingChunk carries a segment of the recording file data.
message RecordingChunk {
  bytes data = 1;
  uint64 sequence = 2;
  map<string, string> metadata = 3;
}

// ─── Configuration (consolidated from config.proto) ───

// ConfigMigrateRequest triggers a configuration migration from the old format.
message ConfigMigrateRequest {}

// ConfigMigrateResponse reports the result of a config migration operation.
message ConfigMigrateResponse {
  repeated string updated_slots = 1;
  repeated string pending_slots = 2;
  bool audio_settings_updated = 3;
}

// TransportConfig represents daemon transport settings (gRPC bindings, TLS).
message TransportConfig {
  string binding = 1;
  int32 port = 2;
  string tls_cert_path = 3;
  string tls_key_path = 4;
  repeated string allowed_origins = 5;
  int32 grpc_port = 6;
  string grpc_binding = 7;
  bool auth_required = 8;
}

// UpdateTransportConfigRequest propagates new transport settings.
message UpdateTransportConfigRequest {
  TransportConfig config = 1;
}

// Adapter describes a stored adapter binary or integration.
message Adapter {
  string id = 1;
  string source = 2;
  string version = 3;
  string type = 4;
  string name = 5;
  string manifest = 6;
  google.protobuf.Timestamp created_at = 7;
  google.protobuf.Timestamp updated_at = 8;
}

// ListAdaptersResponse returns the registry of known adapters.
message ListAdaptersResponse {
  repeated Adapter adapters = 1;
}

// AdapterBinding represents a slot -> adapter assignment.
message AdapterBinding {
  string slot = 1;
  string adapter_id = 2;
  string status = 3;
  string config_json = 4;
  google.protobuf.Timestamp updated_at = 5;
}

// ListAdapterBindingsResponse enumerates bindings for every slot.
message ListAdapterBindingsResponse {
  repeated AdapterBinding bindings = 1;
}

// SetAdapterBindingRequest assigns an adapter to a slot.
message SetAdapterBindingRequest {
  string slot = 1;
  string adapter_id = 2;
  string config_json = 3;
}

// ClearAdapterBindingRequest removes the adapter assignment for a slot.
message ClearAdapterBindingRequest {
  string slot = 1;
}

// QuickstartStatusResponse summarizes progress and adapter state for the quickstart wizard.
message QuickstartStatusResponse {
  bool completed = 1;
  google.protobuf.Timestamp completed_at = 2;
  repeated string pending_slots = 3;
  repeated AdapterEntry adapters = 4;
  repeated string missing_reference_adapters = 5;
}

// QuickstartBinding pairs a slot with the adapter chosen via quickstart.
message QuickstartBinding {
  string slot = 1;
  string adapter_id = 2;
}

// UpdateQuickstartRequest applies quickstart selections.
message UpdateQuickstartRequest {
  repeated QuickstartBinding bindings = 1;
  google.protobuf.BoolValue complete = 2;
}

// LanguageInfo describes a language in four standardised formats so that
// each downstream plugin can pick the representation it needs.
message LanguageInfo {
  string iso1 = 1;          // ISO 639-1 two-letter code, e.g. "pl"
  string bcp47 = 2;         // BCP 47 / IETF language tag, e.g. "pl-PL"
  string english_name = 3;  // English name, e.g. "Polish"
  string native_name = 4;   // Native name, e.g. "Polski"
}

message ListLanguagesRequest {}

message ListLanguagesResponse {
  repeated LanguageInfo languages = 1;
}

// ─── Services ───
//
// NOTE: The Prometheus /metrics endpoint (GET /metrics) is intentionally NOT
// represented as a gRPC RPC. Prometheus scrapes HTTP endpoints by design and
// this is a standard industry exception to AD-7 transport unification.

service DaemonService {
  rpc Status(DaemonStatusRequest) returns (DaemonStatusResponse);
  rpc Shutdown(ShutdownRequest) returns (ShutdownResponse);
  rpc GetPluginWarnings(GetPluginWarningsRequest) returns (GetPluginWarningsResponse);
  rpc ListLanguages(ListLanguagesRequest) returns (ListLanguagesResponse);
  rpc ReloadPlugins(ReloadPluginsRequest) returns (ReloadPluginsResponse);
}

service SessionsService {
  rpc ListSessions(ListSessionsRequest) returns (ListSessionsResponse);
  rpc CreateSession(CreateSessionRequest) returns (CreateSessionResponse);
  rpc GetSession(GetSessionRequest) returns (GetSessionResponse);
  rpc KillSession(KillSessionRequest) returns (KillSessionResponse);
  rpc SendInput(SendInputRequest) returns (SendInputResponse);
  rpc AttachSession(stream AttachSessionRequest) returns (stream AttachSessionResponse);
  rpc GetSessionMode(GetSessionModeRequest) returns (GetSessionModeResponse);
  rpc SetSessionMode(SetSessionModeRequest) returns (SetSessionModeResponse);
  rpc GetConversation(GetConversationRequest) returns (GetConversationResponse);
  rpc GetGlobalConversation(GetGlobalConversationRequest) returns (GetGlobalConversationResponse);
  rpc SendVoiceCommand(SendVoiceCommandRequest) returns (SendVoiceCommandResponse);
}

service AdapterRuntimeService {
  rpc Overview(google.protobuf.Empty) returns (AdaptersOverviewResponse);
  rpc BindAdapter(BindAdapterRequest) returns (AdapterActionResponse);
  rpc StartAdapter(AdapterSlotRequest) returns (AdapterActionResponse);
  rpc StopAdapter(AdapterSlotRequest) returns (AdapterActionResponse);
  rpc RegisterAdapter(RegisterAdapterRequest) returns (RegisterAdapterResponse);
  rpc StreamAdapterLogs(StreamAdapterLogsRequest) returns (stream AdapterLogStreamEntry);
  rpc GetAdapterLogs(GetAdapterLogsRequest) returns (GetAdapterLogsResponse);
}

service AudioService {
  rpc StreamAudioIn(stream StreamAudioInRequest) returns (StreamAudioInResponse);
  rpc StreamAudioOut(StreamAudioOutRequest) returns (stream StreamAudioOutResponse);
  rpc InterruptTTS(InterruptTTSRequest) returns (google.protobuf.Empty);
  rpc GetAudioCapabilities(GetAudioCapabilitiesRequest) returns (GetAudioCapabilitiesResponse);
}

service AuthService {
  rpc ListTokens(ListTokensRequest) returns (ListTokensResponse);
  rpc CreateToken(CreateTokenRequest) returns (CreateTokenResponse);
  rpc DeleteToken(DeleteTokenRequest) returns (google.protobuf.Empty);
  rpc ListPairings(ListPairingsRequest) returns (ListPairingsResponse);
  rpc CreatePairing(CreatePairingRequest) returns (CreatePairingResponse);
  rpc ClaimPairing(ClaimPairingRequest) returns (ClaimPairingResponse);
}

service RecordingsService {
  rpc ListRecordings(ListRecordingsRequest) returns (ListRecordingsResponse);
  rpc GetRecording(GetRecordingRequest) returns (stream RecordingChunk);
}

service ConfigService {
  rpc GetTransportConfig(google.protobuf.Empty) returns (TransportConfig);
  rpc UpdateTransportConfig(UpdateTransportConfigRequest) returns (TransportConfig);
  rpc Migrate(ConfigMigrateRequest) returns (ConfigMigrateResponse);
}

service AdaptersService {
  rpc ListAdapters(google.protobuf.Empty) returns (ListAdaptersResponse);
  rpc ListAdapterBindings(google.protobuf.Empty) returns (ListAdapterBindingsResponse);
  rpc SetAdapterBinding(SetAdapterBindingRequest) returns (AdapterBinding);
  rpc ClearAdapterBinding(ClearAdapterBindingRequest) returns (google.protobuf.Empty);
}

service QuickstartService {
  rpc GetStatus(google.protobuf.Empty) returns (QuickstartStatusResponse);
  rpc Update(UpdateQuickstartRequest) returns (QuickstartStatusResponse);
}
